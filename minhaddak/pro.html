<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minhaddak - Find Your Career Path</title>
    <style>
    .registration-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .edit-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: auto;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      color: #555;
      background-color: #f5f6fa;
      border: 1px solid #ddd;
      transition: 0.2s;
      box-shadow: 3px 3px 8px rgba(0,0,0,0.3); 
    }

    .tab.active {
      background-color: #0b1d3a;
      color: #fff;
      border: none;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: #555;
      margin-bottom: 5px;
    }

    .form-group input {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .continue-btn {
      width: 100%;
      padding: 10px;
      background-color: #0b1d3a;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .continue-btn:hover {
      background-color: #6c6c6c;
    }

    .form-description {
      font-size: 12px;
      color: #888;
      margin-bottom: 15px;
    }
    .spinner {
  width:40px;
  height:40px;
  border:4px solid #ddd;
  border-top:4px solid #0b1d3a;
  border-radius:50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

@keyframes popupFade {
  from { opacity:0; transform:scale(0.9); }
  to { opacity:1; transform:scale(1); }
}

#customAlert > div {
  background:#fff;
  padding:25px 30px;
  border-radius:12px;
  max-width:350px;
  width:85%;
  text-align:center;
  animation: popupFade 0.25s ease;
}

  </style>
</head>
<body>
<div id="site-header"></div>

<script>
fetch('header.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('site-header').innerHTML = html;

    // Load Google Translate script dynamically
    const gtScript = document.createElement('script');
    gtScript.src = "//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
    document.body.appendChild(gtScript);
  });

function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    includedLanguages: 'en,fr,ar',
    layout: google.translate.TranslateElement.InlineLayout.SIMPLE
  }, 'google_translate_element');

  // Style dropdown once it exists
  function styleDropdown() {
    const select = document.querySelector('#google_translate_element select.goog-te-combo');
    if(select){
      select.style.padding = "5px";
      select.style.borderRadius = "5px";
      select.style.border = "1px solid #ccc";
      select.style.fontSize = "14px";
    } else {
      setTimeout(styleDropdown, 500); // retry after delay
    }
  }
  styleDropdown();
}
</script>
    <div class="client-pro-container">
        <button class="client-pro">find someone</button>
        <button class="client-pro active">Pro (Artisan)</button>
    </div>
      <script src="script.js"></script>
    <div class="tabs" style="width: 80%;">
      <div class="tab active" data-tab="register">New Registration</div>
      <div class="tab" data-tab="edit">Edit My Profile</div>
    </div>
    <div class="body_search">
        <!-- this is the registration page -->
        <div class="registration-container">
            <div class="form-description">
                <h2 style="font-weight: 600;">Artisan Registration</h2>
                Free registration for Lebanese artisans and service providers
            </div>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="text" id="phone" placeholder="Phone Number" required />
                </div>
                <div class="form-group">
                    <label for="password">Create Password</label>
                    <input type="password" id="password" placeholder="Password" required />
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
                </div>
                <button class="continue-btn" type="submit">Register</button>
                            <!-- Loading Overlay -->
            <div id="loadingOverlay" style="
              display:none;
              position:fixed;
              top:0; left:0;
              width:100%; height:100%;
              background:rgba(0,0,0,0.4);
              z-index:2000;
              justify-content:center;
              align-items:center;
            ">
              <div style="
                background:#fff;
                padding:25px 30px;
                border-radius:10px;
                text-align:center;
                box-shadow:0 10px 25px rgba(0,0,0,0.2);
              ">
                <div class="spinner"></div>
                <p style="margin-top:15px; font-weight:500;">Loading your profile...</p>
              </div>
              <style>
              .spinner {
                width:40px;
                height:40px;
                border:4px solid #ddd;
                border-top:4px solid #0b1d3a;
                border-radius:50%;
                animation: spin 1s linear infinite;
                margin: auto;
              }

              @keyframes spin {
                100% { transform: rotate(360deg); }
              }
              </style>

            </div>
            </form>
            <script>
              const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqq7yaXez8unYmgbNDbQsS7qN3NHWT0MNDN-crSlVr34k4wAL5oC27qKnPiyMdbF64/exec"; // Replace with deployed web app URL

              // form submit validate passwords
              document.getElementById('registrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading1(); // show loading overlay
                
                const users = await fetchUsers(); // fetch existing users

                const phoneInput = document.getElementById('phone').value.trim();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                // fetch existing users to check if phone exists
                const user1 = users.find(u => u.Phone.toString() === phoneInput);
                try{
                  if(user1) {
                    alert("Phone number is taken","error");
                    return;
                  }
                  else{
                    if (password !== confirmPassword) {
                      alert("Passwords do not match!","error");
                      return;
                    }else{
                      registerUser();
                      alert("Registration successful! please login","success");
                    }
                  }
                }catch(err){
                  console.error(err);
                  alert("Error during registration: " + err.message,"error");
                }finally {
                  hideLoading1(); // ensure loading overlay is hidden
                }
              });

              function showLoading1() {
                document.getElementById("loadingOverlay").style.display = "flex";
              }

              function hideLoading1() {
                document.getElementById("loadingOverlay").style.display = "none";
              }

              async function fetchUsers() {
                try {
                  const res = await fetch(APP_SCRIPT_URL);
                  const data = await res.json();

                  console.log("Fetched users:", data);
                  return Array.isArray(data) ? data : [];
                } catch (err) {
                  console.error(err);
                  alert("Error fetching users: " + err.message);
                  return [];
                }
              }

              async function registerUser() {
                const data = {
                    phone: document.getElementById("phone").value,
                    password: document.getElementById("password").value
                };
                  
                try 
                {
                    let res = await fetch(APP_SCRIPT_URL, {
                      method: "POST",
                      mode: "no-cors",
                      headers: {
                        "Content-Type": "application/json"
                      },
                        body: JSON.stringify({
                            action: "create",
                            Phone: document.getElementById("phone").value,
                            Password: document.getElementById("password").value
                        })
                    });
                    // ‚úÖ Save account locally (example)
                    const accountData = {
                      phone: document.getElementById("phone").value,
                      Password: document.getElementById("password").value
                    };
                    localStorage.setItem("userAccount", JSON.stringify(accountData));

                    // ‚úÖ Switch to Edit tab
                    activateEditTab();

                } 
                catch (err) 
                {
                    console.error(err);
                    alert("Request failed ERROR ON THE REGISTER","error");
                }
              }
                function activateEditTab() {
                  activateTab('edit');
                  const saved = JSON.parse(localStorage.getItem("userAccount"));
                  if (saved) {
                    if (document.getElementById("editPhone")) {
                      document.getElementById("editPhone").value = saved.phone || "";
                    }
                    if (document.getElementById("editPassword")) {
                      document.getElementById("editPassword").value = saved.password || "";
                    }
                  }
                }
                function activateTab(tabName) {
                  const tabs = document.querySelectorAll(".tab");
                  const registrationContainer = document.querySelector(".registration-container");
                  const editContainer = document.querySelector(".edit-container");

                  // Reset tabs
                  tabs.forEach(t => t.classList.remove("active"));

                  if (tabName === "edit") {
                    // Activate Edit tab
                    document.querySelector('.tab[data-tab="edit"]').classList.add("active");

                    // Show Edit page
                    registrationContainer.style.display = "none";
                    editContainer.style.display = "block";
                  }

                  if (tabName === "register") {
                    // Activate Register tab
                    document.querySelector('.tab[data-tab="register"]').classList.add("active");

                    // Show Register page
                    registrationContainer.style.display = "block";
                    editContainer.style.display = "none";
                  }
                }
            </script>
        </div>

        <!-- Edit Page -->
        <div class="edit-container">
          <div class="form-description">
            <h2 style="font-weight: 600;">Login</h2>
            <p>Enter your phone number and password to edit your existing profile</p>
          </div>
          <form id="editForm">
            <div class="form-group">
              <label for="editPhone">Phone Number</label>
              <input type="text" id="editPhone" placeholder="Phone Number" required />
            </div>
            <div class="form-group">
              <label for="editPassword">Password</label>
              <input type="password" id="editPassword" placeholder="Password" required />
            </div>
            <button class="continue-btn" type="submit">Continue</button>
            <!-- Loading Overlay -->
            <div id="loadingOverlay1" style="
              display:none;
              position:fixed;
              top:0; left:0;
              width:100%; height:100%;
              background:rgba(0,0,0,0.4);
              z-index:2000;
              justify-content:center;
              align-items:center;
            ">
              <div style="
                background:#fff;
                padding:25px 30px;
                border-radius:10px;
                text-align:center;
                box-shadow:0 10px 25px rgba(0,0,0,0.2);
              ">
                <div class="spinner"></div>
                <p style="margin-top:15px; font-weight:500;">Loading your profile...</p>
              </div>
              <style>
              .spinner {
                width:40px;
                height:40px;
                border:4px solid #ddd;
                border-top:4px solid #0b1d3a;
                border-radius:50%;
                animation: spin 1s linear infinite;
                margin: auto;
              }

              @keyframes spin {
                100% { transform: rotate(360deg); }
              }
              </style>

            </div>

          </form>
        </div>

        <!-- Modal for editing profile -->
        <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
          <div style="background:#fff; padding:20px; border-radius:10px; width:400px; max-height:90vh; overflow-y:auto; position:relative;">
            <span id="closeModal" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px;">&times;</span>
            <h3>Edit Your Profile</h3>
            <form id="profileForm">
              <!-- Name -->
              <div class="form-group">
                <label for="editName">Name</label>
                <input type="text" id="editName" placeholder="Your Name" />
              </div>

              <!-- Email -->
              <div class="form-group">
                <label for="editEmail">Email</label>
                <input type="email" id="editEmail" placeholder="Your Email" />
              </div>

              <!-- Profession -->
              <div class="form-group">
                <label for="editProfession">Profession</label>
                <select id="editProfession">
                  <option value="">Select Profession</option>
                  <option value="personal-trainerTrade">üèãÔ∏è personal-trainerTrade</option>
                  <option value="nail-technicianTrade">üíÖ nail-technicianTrade</option>
                  <option value="Home Hairdresser">‚úÇÔ∏è Home Hairdresser</option>
                  <option value="Plumber">üîß Plumber</option>
                  <option value="electrician">‚ö° Electrician</option>
                  <option value="menuisier">ü™ö Carpenter</option>
                  <option value="Tiler/Flooring Installer">üß± Tiler/Flooring Installer</option>
                  <option value="Cleaning Agent">üßπ Cleaning Agent</option>
                  <option value="Plasterer/Painter">üé® Plasterer / Painter</option>
                  <option value="Locksmith">üîê Locksmith</option>
                  <option value="mechanic">üîß Mechanic</option>
                  <option value="Glazier">ü™ü Glazier</option>
                  <option value="HVAC/Refrigeration Technician">‚ùÑÔ∏è HVAC/Refrigeration Technician</option>
                  <option value="blacksmith">üî• Blacksmith</option>
                  <option value="appliance-repair-technician">üîå Appliance Repair Technician</option>
                  <option value="gardener">üå± Gardener</option>
                </select>
              </div>

              <!-- Profile Picture -->
              <div class="form-group">
                <label for="profilePic">Profile Picture</label>
                <input type="file" id="profilePic" accept="image/*" />
                <img id="profilePreview" src="" alt="Profile Preview" style="display:none; width:100px; height:100px; margin-top:10px; object-fit:cover; border-radius:50%;">
              </div>

              <!-- Additional Images -->
              <div class="form-group">
                <label for="additionalPics">Additional Images (up to 3)</label>
                <input type="file" id="additionalPics" accept="image/*" multiple />
                <div id="additionalPreview" style="display:flex; gap:10px; margin-top:10px;"></div>
              </div>

              <!-- About -->
              <div class="form-group">
                <label for="about">About / Description</label>
                <textarea id="about" placeholder="Tell us about yourself..." rows="3"></textarea>
              </div>
              <!-- experience-->
               <div>
                <label for="experience">Experience</label>
                <textarea id="experience" placeholder="Tell us about your experience..." rows=""></textarea>
               </div>
              <!-- Location -->
              <div class="form-group">
                <label for="location">Location</label>
                <!-- Input -->
                <input id="location" type="text" placeholder="City / Address" style="height: 30px; width: 90%; border-radius: 5px; font-size:90%; border: solid 1px rgb(138,177,228);" placeholder="Enter location (e.g., Kaslik, Achrafieh)" autocomplete="off" />
                <!-- Autofill button --> 
                <button id="autoLocationBtn" style="width: 40px; height: 30px; border: 1px solid #000; background-color: white; border-radius: 5px; border: solid 1px rgb(138, 177, 228);font-size: 16px; cursor: pointer; box-shadow: 3px 3px 10px rgba(0,0,0,0.4); position: relative; overflow: hidden;">
                  <video autoplay muted loop playsinline style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;">
                    <source src="img/Location Icon Animation.mp4" type="video/mp4">
                  </video>
                </button>
                <script>
                  document.getElementById("autoLocationBtn").addEventListener("click", () => {
                    if (!navigator.geolocation) {
                        alert("Geolocation is not supported by your browser");
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                      async (position) => {
                          const lat = position.coords.latitude;
                          const lon = position.coords.longitude;
                          // Optional: save globally
                          window.selectedLocation = { lat, lon, name: "" };
                          // Reverse geocode using OpenStreetMap Nominatim API
                          try {
                              const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                              const data = await res.json();
                              const city = data.address.city || data.address.town || data.address.village || data.display_name;

                              // Fill input with city/location
                              const input = document.getElementById("location");
                              input.value = city;

                              // Save name in global variable
                              window.selectedLocation.name = city;
                              console.log("User location autofilled:", window.selectedLocation);
                          } catch (err) {
                              console.error("Reverse geocoding failed:", err);
                              alert("Could not get location name");
                          }
                        },
                        (error) => {
                            console.error("Geolocation error:", error);
                            alert("Unable to retrieve your location");
                        }
                    );
                  });
                </script>
              </div>
              <button id="saveProfileBtn" style="padding:10px 15px; background:#0b1d3a; color:#fff; border:none; border-radius:5px; cursor:pointer;" type="submit">Save Profile</button>
             
            </form>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyqq7yaXez8unYmgbNDbQsS7qN3NHWT0MNDN-crSlVr34k4wAL5oC27qKnPiyMdbF64/exec";

const editModal = document.getElementById('editModal');
const closeModal = document.getElementById('closeModal');

// Close modal
closeModal.addEventListener('click', () => editModal.style.display = "none");

// Env variables
let envphoneInput = "";
let envpasswordInput = "";

// Convert file to Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

// Get Base64 images from inputs
async function getBase64Images() {
  const images = {};

  // Profile picture
  const profileFile = document.getElementById('profilePic').files[0];
  if(profileFile) images.ProfilePic = await fileToBase64(profileFile);

  // Additional images (up to 3)
  const additionalFiles = document.getElementById('additionalPics').files;
  if(additionalFiles.length){
    Array.from(additionalFiles).slice(0,3).forEach((file, index) => {
      images[`Picture${index+1}`] = fileToBase64(file); // Picture1, Picture2, Picture3
    });
    // await each conversion
    for(let i = 0; i < Math.min(additionalFiles.length, 3); i++){
      images[`Picture${i+1}`] = await fileToBase64(additionalFiles[i]);
    }
  }

  return images;
}
function showLoading() {
  document.getElementById("loadingOverlay1").style.display = "flex";
}

function hideLoading() {
  document.getElementById("loadingOverlay1").style.display = "none";
}


// Preview images
document.getElementById('profilePic').addEventListener('change', e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = () => {
      const img = document.getElementById('profilePreview');
      img.src = reader.result;
      img.style.display = 'block';
    }
    reader.readAsDataURL(file);
  }
});

document.getElementById('additionalPics').addEventListener('change', e => {
  const files = e.target.files;
  const previewContainer = document.getElementById('additionalPreview');
  previewContainer.innerHTML = '';
  Array.from(files).slice(0,3).forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      const img = document.createElement('img');
      img.src = reader.result;
      img.style.width = '80px';
      img.style.height = '80px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '5px';
      previewContainer.appendChild(img);
    }
    reader.readAsDataURL(file);
  });
});

// Login form submit
document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  envphoneInput = document.getElementById('editPhone').value;
  envpasswordInput = document.getElementById('editPassword').value;

  showLoading(); // üî• START LOADING

  try {
    const response = await fetch(API_URL);
    const users = await response.json();
    const user = users.find(u => u.Phone.toString() === envphoneInput && u.Password === envpasswordInput);

    if(user){
      document.getElementById('editName').value = user.Name || "";
      document.getElementById('editEmail').value = user.Email || "";
      document.getElementById('editProfession').value = user.Profession || "";
      document.getElementById('profilePic').value = user.ProfilePic || "";
      document.getElementById('about').value = user.About || "";
      document.getElementById('location').value = user.Location || "";

      if(user.ProfilePic){
        const img = document.getElementById('profilePreview');
        img.src = user.ProfilePic;
        img.style.display = 'block';
      }

    if(user.Picture1){
      const previewContainer = document.getElementById('additionalPreview');
      previewContainer.innerHTML = "";
      ['Picture1','Picture2','Picture3'].forEach(key => {
        if(user[key]){
          const img = document.createElement("img");
          img.src = user[key];
          img.style.width = "80px";
          img.style.height = "80px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "5px";
          previewContainer.appendChild(img);
        }
      });
    }
    } else {
      alert("Phone number or password is incorrect! Retry","error");
    }

  } catch(err){
    console.error(err);
    alert("Failed to fetch user data. Please try again later.","error");
  }  finally {
    hideLoading(); // üî• STOP LOADING
  }
});

// Profile form submit
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  if(!envphoneInput || !envpasswordInput){
    alert("You must log in first!","error");
    return;
  }

  try {
    // Convert images to Base64
    const images = await getBase64Images();
    showLoading(); // üî• START LOADING
    // Delete existing user first
    const deleteRes = await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "delete",
        Phone: envphoneInput
      })
    });

    // Create new user with updated info + images
    const data = {
      action: "create",
      Phone: envphoneInput,
      Password: envpasswordInput,
      Name: document.getElementById("editName").value,
      Email: document.getElementById("editEmail").value,
      Profession: document.getElementById("editProfession").value,
      About: document.getElementById("about").value,
      Location: document.getElementById("location").value,
      ...images
    };

    const createRes = await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    alert("Profile updated successfully!","success");
    hideLoading(); // üî• STOP LOADING
  } catch(err){
    console.error(err);
    alert("Failed to update profile.","error");
  }
  window.location.href = "index.html"; // redirect to index after editing
});
</script>
        <script>
            const tabs = document.querySelectorAll('.tab');
            const registrationContainer = document.querySelector('.registration-container');
            const editContainer = document.querySelector('.edit-container');

            // hide edit container by default
            editContainer.style.display = 'none';

            tabs.forEach((tab, index) => {
                tab.addEventListener('click', () => {
                // toggle active class on tabs
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // index 0 = New Registration, index 1 = Edit My Profile
                if(index === 0){
                    registrationContainer.style.display = 'block';
                    editContainer.style.display = 'none';
                } else {
                    registrationContainer.style.display = 'none';
                    editContainer.style.display = 'block';
                }
                });
            });

        </script>

    </div>
</body>

            // registration form submit handler
            const form = document.getElementById('registrationForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const API_URL  = "https://script.google.com/macros/s/AKfycbyqq7yaXez8unYmgbNDbQsS7qN3NHWT0MNDN-crSlVr34k4wAL5oC27qKnPiyMdbF64/exec";
             
                // if phone already exists, alert and return
                const user = users.find(u => u.Phone.toString() === phone);
                if(user) {
                  alert("Phone number already registered! Please login.","error");
                  return;
                }else{
                  alert("Phone number is available!","success");
                }
                if(password !== confirmPassword){
                    alert("Passwords do not match! down there","error");
                return;
                }

                console.log("Phone:", phone);
                console.log("Password:", password);
                alert("Registration submitted! Now you can log in to edit your profile.","success");
            });